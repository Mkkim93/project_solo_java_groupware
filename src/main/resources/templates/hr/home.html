<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://kit.fontawesome.com/4526b6a2d0.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.15/index.global.min.js'></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="/js/current.js"></script>
</head>
<body>
<div class="dashboard">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar-section">
        <div class="profile-section">
            <form th:action="@{/hr/detail}" th:object="${employeeDto}" method="get">
                <h3 type="text" id="empName" name="empName" th:text="*{empName}"></h3>
                <h3 type="text" id="empRank" name="empRank" th:text="*{empRank}"></h3>
                <h3 type="text" id="deptName" name="deptName" th:text="${departmentDto.deptName}"></h3>
                <h3 type="text" id="roleType" name="roleType" th:text="${employeeDto.roleType}"></h3>
                <button type="submit" class="btn">ë‚˜ì˜ ì •ë³´</button>
            </form>
        </div>

        <ul class="menu">
            <li><a href="/hr/home"><i class="fa-solid fa-house"></i> í™ˆ</a></li>
            <li><a href="/board/all/list"><i class="fa-solid fa-pen"></i> ê²Œì‹œíŒ</a></li>
            <li><a href="/todo/detail"><i class="fa-regular fa-calendar"></i> ì¼ì •</a></li>
            <li><a href="/mail/list"><i class="fa-solid fa-envelope"></i> ë©”ì¼</a></li>
            <li><a href="#"><i class="fa-regular fa-comments"></i> ë©”ì‹ ì €</a></li>
            <li><a href="#"><i class="fa-solid fa-pen-to-square"></i> ì „ìê²°ì œ</a></li>
            <li><a href="#"><i class="fa-solid fa-gear"></i> ì„¤ì •</a></li>
            <li><a href="/admin/main"><i class="fa-solid fa-gear"></i> ê´€ë¦¬ì í˜ì´ì§€</a></li>
        </ul>
    </div>
    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
    <div class="main-content">
        <header class="header">
            <h2>My Portal</h2>
            <input type="hidden" id="id" name="id" th:value="${attendanceDto != null ? attendanceDto.id : 0}">
            <input type="hidden" id="attOn" name="attOn" th:value="${attendanceDto != null ? attendanceDto.attOn : ''}">
            <input type="hidden" id="attOff" name="attOff" th:value="${attendanceDto != null ? attendanceDto.attOff : ''}">
            <input type="hidden" id="attDuration" name="attDuration" th:value="${attendanceDto != null ? attendanceDto.attDuration : ''}">
            <input type="hidden" id="employee" name="employee" th:value="${attendanceDto != null ? attendanceDto.employee : 0}">

            <div class="attendance-buttons">
                <h3>í˜„ì¬ ì‹œê°„ : <span id="current-time"></span></h3>
                <button id="comment-attOn-btn" class="btn attOn" onclick="attOnLogic()">ì¶œê·¼</button>
                <button id="comment-attOff-btn" class="btn attOff" onclick="attOffLogic()">í‡´ê·¼</button>
            </div>

            <div class="attendance-times">
                <h3>ì¶œê·¼ ì‹œê°„: <span id="checkInTime" th:text="${attendanceDto != null ? attendanceDto.attOn : ''}"></span></h3>
                <h3>í‡´ê·¼ ì‹œê°„: <span id="checkOutTime" th:text="${attendanceDto != null ? attendanceDto.attOff : ''}"></span></h3>
                <h3>ê¸ˆì¼ ê·¼ë¬´ ì‹œê°„: <span id="durationTime" th:text="${attendanceDto != null ? attendanceDto.attDuration : ''}"></span></h3>
            </div>

            <div class="header-right">
                <input type="text" placeholder="í†µí•©ê²€ìƒ‰">
                <i class="bell-icon">ğŸ””</i>
                <i class="user-icon">ğŸ‘¤</i>
            </div>
        </header>

        <div class="dashboard">
            <section class="stats">
                <div class="stat-card large">
                    <h3 class="text-center">ë‚˜ì˜ ì¼ì • ë³´ê¸°</h3>
                    <iframe type="text/html" src="/todo/readonly" width="700" height="650" border="none"></iframe>
                    <button th:onclick="|location.href='@{/todo/detail}'|" class="btn">ë‚˜ì˜ ì¼ì • ê´€ë¦¬</button>
                </div>
            </section>

            <section class="extra-stats">
                <div class="stat-card">
                    <h3 class="text-center">ë‚˜ì˜ ê·¼íƒœ í˜„í™©</h3>
                    <canvas id="attendance-chart"></canvas>
                    <button th:onclick="|location.href='@{/hr/atten}'|" class="btn btn-primary btn-create">ë‚˜ì˜ ê·¼íƒœ ìƒì„¸</button>
                </div>
                <div class="stat-card">
                    <h3 class="text-center">ê²Œì‹œíŒ</h3>
                    <canvas id="another-chart"></canvas>
                </div>
                <div class="stat-card">
                    <h3 class="text-center">ë©”ì¼í•¨</h3>
                    <canvas id="project-chart"></canvas>
                </div>
                <div class="stat-card">
                    <h3 class="text-center">ì—…ë¬´ ì§„í–‰ í˜„í™©</h3>
                    <canvas id="task-chart"></canvas>
                </div>
            </section>
        </div>

        <section class="notifications">
            <div class="notification-card1">
                <h3 class="text-center">ìµœê·¼ ì•Œë¦¼</h3>
                <ul id="notifications1">
                    <li>ì•Œë¦¼ ì œëª© test1 : ì•Œë¦¼ ë‚´ìš© test1</li>
                    <li>ì•Œë¦¼ ì œëª© test2 : ì•Œë¦¼ ë‚´ìš© test2</li>
                    <li>ì•Œë¦¼ ì œëª© test3 : ì•Œë¦¼ ë‚´ìš© test3</li>
                </ul>
            </div>


            <div class="notification-card2">
                <h3 class="text-center">ì‚¬ë‚´ ê³µì§€</h3>
                <ul id="notifications2"> <!-- Correct the id to match the one in your JS -->
                    <!-- List will be dynamically filled -->
                </ul>
            </div>
        </section>

    </div>
</div>

<script th:inline="javascript">
    const attOnLogic = () => {
        const id = document.getElementById("id").value || 9;
        const attOn = document.getElementById("attOn").value || '';
        const employee = document.getElementById("employee").value || 29;
        var currentTime = new Date().toLocaleTimeString();

        if (attOn) {
            alert("ì´ë¯¸ ì¶œê·¼í•˜ì…¨ìŠµë‹ˆë‹¤.");
            return;
        }

        $.ajax({
            type: "POST",
            url: "/att/in",
            contentType: "application/json",
            data: JSON.stringify({
                "id": id,
                "employee": employee,
                "attOn": attOn
            }),
            success: function (res) {
                alert("ì¶œê·¼ì´ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('checkInTime').innerHTML = currentTime;
                location.reload();
            },
            error: function (err) {
                console.log("ì¶œê·¼ ì‹¤íŒ¨", err);
            }
        });
    };
</script>

<script th:inline="javascript">
    const attOffLogic = () => {
        const id = document.getElementById("id").value || 0;
        const employee = document.getElementById("employee").value || 0;
        const attOff = document.getElementById("attOff").value || '';
        const currentTime = new Date().toLocaleTimeString(); // í˜„ì¬ ì‹œê°„ì„ í¬ë§·

        if (attOff) {
            alert("ì´ë¯¸ í‡´ê·¼í•˜ì…¨ìŠµë‹ˆë‹¤.");
            return;
        }

        $.ajax({
            type: "POST",
            url: "/att/out",
            contentType: "application/json", // ì¶”ê°€
            data: {
                "id": id,
                "employee": employee,
                "attOff": attOff
            },
            success: function(res) {

                console.log("ì„œë²„ ì‘ë‹µ:", res);

                const totalMinutes = parseInt(res.attDuration, 10) || 0; // 'attDuration' ì´ ë¬¸ìì—´ì¼ ê²½ìš° ë³€í™˜
                const hours = Math.floor(totalMinutes / 60); // ì „ì²´ ë¶„ì„ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                const minutes = totalMinutes % 60; // ë‚˜ë¨¸ì§€ë¥¼ ë¶„ìœ¼ë¡œ ë³€í™˜

                // Update the display
                document.getElementById("checkOutTime").textContent = currentTime; // í‡´ê·¼ ì‹œê°„ í‘œì‹œ
                document.getElementById("durationTime").textContent = `${hours} ì‹œê°„ ${minutes} ë¶„`; // ì‹œê°„ê³¼ ë¶„ í‘œì‹œ
                alert("í‡´ê·¼ì´ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤");
                console.log(res);
            },
            error: function (err) {
                console.log("í‡´ê·¼ ì²˜ë¦¬ ì‹¤íŒ¨", err);
            }
        });
    };
</script>

<script th:inline="javascript">
    let attendancePerception = [[${attendanceDto != null ? attendanceDto.attPerception : 0}]];
    let attendanceLeave = [[${attendanceDto != null ? attendanceDto.attLeave : 0}]];
    let attendanceVacation = [[${attendanceDto != null ? attendanceDto.attVacation : 0}]];

    const ctx = document.getElementById('attendance-chart').getContext('2d');
    const attendanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['ì§€ê°', 'ë°˜ì°¨', 'íœ´ê°€'],
            datasets: [{
                label: 'ê·¼íƒœ í˜„í™©',
                data: [attendancePerception, attendanceLeave, attendanceVacation],
                backgroundColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
    // ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
    function loadNoticeContent() {
        const url = '/api/notice';  // API ì—”ë“œí¬ì¸íŠ¸ (ì„œë²„ì—ì„œ ê³µì§€ì‚¬í•­ ë°ì´í„°ë¥¼ ë°˜í™˜í•œë‹¤ê³  ê°€ì •)
        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log('data', data);  // Check the structure of the data
                console.log('data.content', data.content);  // If data.content exists, use it
                updateNoticeTable(data.content);  // Pass the content of the notices to the update function
            })
            .catch(error => {
                console.log('Error:', error);
            });
    }

    // ê³µì§€ì‚¬í•­ ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateNoticeTable(noticeData) {
        const noticeList = document.getElementById("notifications2");  // Ensure this matches the HTML id
        noticeList.innerHTML = '';  // ê¸°ì¡´ ê³µì§€ì‚¬í•­ ëª©ë¡ì„ ì´ˆê¸°í™”

        if (!Array.isArray(noticeData)) {
            noticeData = [noticeData];  // If noticeData is not an array, convert it to one
        }

        // noticeData ë°°ì—´ì„ ìˆœíšŒí•˜ë©´ì„œ ë™ì ìœ¼ë¡œ ê³µì§€ì‚¬í•­ì„ ì¶”ê°€
        noticeData.forEach(data => {
            console.log('data.boardTitle', data.boardTitle);
            console.log('data.boardRegDate', data.boardRegDate);

            // ê° ê³µì§€ì‚¬í•­ì„ ë‚˜íƒ€ë‚´ëŠ” <li> ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ìƒì„±
            const listItem = document.createElement("li");
            listItem.classList.add("text-center");

            // ê³µì§€ ì œëª©ê³¼ ë‚ ì§œë¥¼ ë™ì ìœ¼ë¡œ ì¶”ê°€
            listItem.innerHTML = `
            <strong class="text-center">${data.boardTitle}</strong>: ${data.boardRegDate}
        `;

            // <ul>ì— <li> ì¶”ê°€
            noticeList.appendChild(listItem);
        });
    }
</script>
<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œê°„ ê°±ì‹ ê³¼ ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener("DOMContentLoaded", function() {
        loadNoticeContent(); // í˜ì´ì§€ ë¡œë“œì‹œ ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜´
        updateTime();        // í˜ì´ì§€ ë¡œë“œì‹œ ì‹œê°„ì„ ê°±ì‹ 
    });
</script>
</body>
</html>