<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://kit.fontawesome.com/4526b6a2d0.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.15/index.global.min.js'></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <!--<link rel="stylesheet" href="/resource/css/bootstrap.css">-->
    <style>
        .embedded-object {
            width: 100%;
            height: auto;
            max-width: 400px;
        }
    </style>
</head>
<body>
<div class="dashboard">
    <!-- 사이드바 -->
    <div class="sidebar">
        <div class="profile-section">
            <form th:action="@{/hr/employeedetailview}" th:object="${employeeDTO}" method="get">
                <h3 type="text" id="empName" name="empName" th:text="${employeeDTO.empName}"></h3>
                <h3 type="text" id="empRank" name="empRank" th:text="${employeeDTO.empRank}"></h3>
                <h3 type="text" id="deptName" name="deptName" th:text="${departmentDTO.deptName}"></h3>
                <button type="submit" class="btn">나의 정보</button>
            </form>
        </div>
        <ul class="menu">
            <li><a href="/hr/myPage"><i class="fa-solid fa-house"></i> 홈</a></li>
            <li><a href="/board/boardlist"><i class="fa-solid fa-pen"></i> 게시판</a></li>
            <li><a href="/todo/calendar"><i class="fa-regular fa-calendar"></i> 일정</a></li>
            <li><a href="#"><i class="fa-solid fa-envelope"></i> 메일</a></li>
            <li><a href="#"><i class="fa-brands fa-signal-messenger"></i> 메신저</a></li>
            <li><a href="#"><i class="fa-solid fa-cart-shopping"></i> 당근</a></li>
            <li><a href="#"><i class="fa-solid fa-m"></i> 마일리지상점</a></li>
            <li><a href="#"><i class="fa-solid fa-people-group"></i> 사내동호회</a></li>
            <li><a href="#"><i class="fa-solid fa-gear"></i> 설정</a></li>
        </ul>
    </div>

    <!-- 메인 대시보드 -->
    <div class="main-content">
        <header class="header">
            <h2>My Portal</h2>
            <input type="hidden" id="id" name="id" th:value="${attendanceDTO != null ? attendanceDTO.id : 0}">
            <input type="hidden" id="attOn" name="attOn" th:value="${attendanceDTO != null ? attendanceDTO.attOn : ''}">
            <input type="hidden" id="attOff" name="attOff" th:value="${attendanceDTO != null ? attendanceDTO.attOff : ''}">
            <input type="hidden" id="attDuration" name="attDuration" th:value="${attendanceDTO != null ? attendanceDTO.attDuration : ''}">
            <input type="hidden" id="employee" name="employee" th:value="${attendanceDTO != null ? attendanceDTO.employee : 0}">

            <div class="attendance-buttons">
                <button id="comment-attOn-btn" class="btn attOn" onclick="attOnLogic()">출근</button>
                <button id="comment-attOff-btn" class="btn attOff" onclick="attOffLogic()">퇴근</button>
            </div>
            <div class="attendance-times">
                <h3>출근 시간: <span id="checkInTime" th:text="${attendanceDTO != null ? attendanceDTO.attOn : ''}"></span></h3>
                <h3>퇴근 시간: <span id="checkOutTime" th:text="${attendanceDTO != null ? attendanceDTO.attOff : ''}"></span></h3>
                <h3>금일 근무 시간: <span id="durationTime" th:text="${attendanceDTO != null ? attendanceDTO.attDuration : ''}"></span></h3>
            </div>

            <div class="header-right">
                <input type="text" placeholder="통합검색">
                <i class="bell-icon">🔔</i>
                <i class="user-icon">👤</i>
            </div>
        </header>

        <div class="dashboard">
            <!-- 상단 섹션: 진행 중인 프로젝트 -->
            <section class="stats">
                <div class="stat-card large">
                    <h3 class="text-center">나의 일정 보기</h3>
                    <iframe type="text/html" src="/todo/readonly" width="700" height="650" border="none"></iframe>
                    <button th:onclick="|location.href='@{/todo/detail}'|" class="btn">나의 일정 관리</button>
                </div>
            </section>

            <section class="extra-stats">
                <div class="stat-card">
                    <h3 class="text-center">나의 근태 현황</h3>
                    <canvas id="attendance-chart"></canvas>
                    <button th:onclick="|location.href='@{/hr/detail}'|" class="btn btn-primary btn-create">나의 근태 상세</button>
                </div>
                <div class="stat-card">
                    <h3 class="text-center">팀원별 프로젝트 진행 현황</h3>
                    <canvas id="another-chart"></canvas>
                </div>
                <div class="stat-card">
                    <h3 class="text-center">진행 중인 프로젝트 현황</h3>
                    <canvas id="project-chart"></canvas>
                </div>
                <div class="stat-card">
                    <h3 class="text-center">업무 진행 현황</h3>
                    <canvas id="task-chart"></canvas>
                </div>
            </section>
        </div>

        <section class="notifications">
            <div class="notification-card">
                <h3>최근 알림</h3>
                <ul>
                    <li>알림 제목 test1 : 알림 내용 test1</li>
                    <li>알림 제목 test2 : 알림 내용 test2</li>
                    <li>알림 제목 test3 : 알림 내용 test3</li>
                </ul>
            </div>
            <div class="notification-card">
                <h3>메일함</h3>
                <ul>
                    <li>메일 제목 test1: 메일 내용 test1</li>
                    <li>메일 제목 test2: 메일 내용 test2</li>
                </ul>
            </div>
        </section>

        <!-- 출근 및 퇴근 시간 표시 섹션 추가 -->

    </div>
</div>

<script th:inline="javascript">
    const attOnLogic = () => {
        const id = document.getElementById("id").value || 0;  // 기본값 설정
        const attOn = document.getElementById("attOn").value || '';
        const employee = document.getElementById("employee").value || 0;
        const currentTime = new Date().toLocaleTimeString(); // 현재 시간을 포맷

        // 출근 시간 존재 여부 확인
        if (attOn) {
            alert("이미 출근하셨습니다.");
            return; // 이미 출근한 경우 종료
        }

        $.ajax({
            type: "POST",
            url: "/attendance/on",
            data: {
                "id": id,
                "employee": employee,
                "attOn": attOn
            },
            success: function (res) {
                document.getElementById("checkInTime").textContent = currentTime; // 출근 시간 표시
                alert("열심히 일해라");
                console.log("출근 완료", res);
            },
            error: function (err) {
                console.log("출근 실패", err);
            }
        });
    };
</script>

<script th:inline="javascript">
    const attOffLogic = () => {
        const id = document.getElementById("id").value || 0;
        const employee = document.getElementById("employee").value || 0;
        const attOff = document.getElementById("attOff").value || '';
        const currentTime = new Date().toLocaleTimeString(); // 현재 시간을 포맷
        // 퇴근 시간 존재 여부 확인
        if (attOff) {
            alert("이미 퇴근하셨습니다.");
            return; // 이미 퇴근한 경우 종료
        }

        $.ajax({
            type: "POST",
            url: "/attendance/off",
            data: {
                "id": id,
                "employee": employee,
                "attOff": attOff
            },
            success: function(res) {
                // 서버에서 반환된 attDuration 확인
                console.log("서버 응답:", res);  // 서버 응답 확인

                const totalMinutes = parseInt(res.attDuration, 10) || 0; // 'attDuration' 이 문자열일 경우 변환
                const hours = Math.floor(totalMinutes / 60); // 전체 분을 시간으로 변환
                const minutes = totalMinutes % 60; // 나머지를 분으로 변환

                // Update the display
                document.getElementById("checkOutTime").textContent = currentTime; // 퇴근 시간 표시
                document.getElementById("durationTime").textContent = `${hours} 시간 ${minutes} 분`; // 시간과 분 표시
                alert("퇴근처리 되었습니다");
                console.log(res);
            },
            error: function (err) {
                console.log("퇴근 처리 실패", err);
            }
        });
    };
</script>

<script th:inline="javascript">
    let attendancePerception = [[${attendanceDTO != null ? attendanceDTO.attPerception : 0}]];
    let attendanceLeave = [[${attendanceDTO != null ? attendanceDTO.attLeave : 0}]];
    let attendanceVacation = [[${attendanceDTO != null ? attendanceDTO.attVacation : 0}]];

    const ctx = document.getElementById('attendance-chart').getContext('2d');
    const attendanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['지각', '반차', '휴가'],
            datasets: [{
                label: '근태 현황',
                data: [attendancePerception, attendanceLeave, attendanceVacation],
                backgroundColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>

</body>
</html>
